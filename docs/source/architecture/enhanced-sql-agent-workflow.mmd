---
title: Enhanced SQL Agent Workflow
---
graph TD
    %% Main Workflow
    A[🤔 User Question] --> B[🔍 Analyze Question]
    B --> C[🔗 Schema Linking]
    C --> D[📋 Query Planning]
    D --> E[⚡ Generate SQL]
    E --> F[🛡️ Validate Safety]

    %% Safety Check Branch
    F --> G{🔒 Safety Check}
    G -->|✅ Pass| H[▶️ Execute Query]
    G -->|❌ Fail| M[📝 Format Response]

    %% Execution Branch
    H --> I{📊 Execution Result}
    I -->|✅ Success| M[📝 Format Response]
    I -->|❌ Error| J[🛠️ Handle Error]
    I -->|🔄 Retry Needed| E

    %% Error Handling Branch
    J --> K{🤔 Should Retry?}
    K -->|🔄 Yes, Retry < Max| E
    K -->|🛑 No, Give Up| M

    %% Final Output
    M --> N[📝 Final Answer]

    %% Styling
    classDef startEnd fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#000
    classDef process fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef decision fill:#fff8e1,stroke:#f57c00,stroke-width:2px,color:#000
    classDef error fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000
    classDef success fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000

    class A,N startEnd
    class B,C,D,E,H,M process
    class G,I,K decision
    class J error
    class F success
